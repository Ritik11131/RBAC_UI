<div class="relative flex items-stretch" #dropdownContainer>
  <!-- Dropdown position: Start -->
  @if (selectPosition === 'start') {
    <div class="relative z-10 flex-shrink-0">
      <!-- Country Selector Button -->
      <button
        type="button"
        (click)="toggleDropdown()"
        [disabled]="disabled"
        class="h-11 rounded-l-lg border-r-0 border-y border-l bg-white dark:bg-gray-900 px-3.5 pr-7 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 focus:outline-hidden focus:ring-2 focus:ring-brand-500/20 disabled:cursor-not-allowed disabled:opacity-50 transition-colors flex items-center justify-center gap-1.5 shadow-theme-xs"
        [ngClass]="{
          'border-error-500': error,
          'border-gray-300 dark:border-gray-700': !error
        }"
      >
        <span class="font-medium whitespace-nowrap">{{ getSelectedCountryLabel() }}</span>
        <svg
          class="stroke-current transition-transform flex-shrink-0"
          [ngClass]="{'rotate-180': isDropdownOpen}"
          width="16"
          height="16"
          viewBox="0 0 16 16"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M3.8335 5.9165L8.00016 10.0832L12.1668 5.9165" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </button>

      <!-- Custom Dropdown Menu -->
      @if (isDropdownOpen) {
        <div class="absolute left-0 top-full mt-1 z-50 w-48 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg max-h-80 overflow-y-auto">
          @for (country of availableCountries; track country.code) {
            <button
              type="button"
              (click)="selectCountry(country)"
              class="w-full px-4 py-2.5 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex items-center justify-between"
              [ngClass]="{
                'bg-brand-50 dark:bg-brand-500/10 text-brand-600 dark:text-brand-400': selectedCountry === country.code,
                'text-gray-700 dark:text-gray-300': selectedCountry !== country.code
              }"
            >
              <span class="font-medium">{{ country.label }}</span>
              @if (selectedCountry === country.code) {
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
              }
            </button>
          }
        </div>
      }
    </div>
  }

  <!-- Input field -->
  <input 
    type="tel" 
    [value]="phoneNumber"
    [placeholder]="placeholder"
    (input)="handlePhoneNumberChange($event)"
    [disabled]="disabled"
    [ngClass]="{
      'rounded-l-lg border-l': selectPosition === 'end',
      'rounded-r-lg border-r border-l-0': selectPosition === 'start',
      'rounded-lg border': selectPosition !== 'start' && selectPosition !== 'end',
      'border-error-500 focus:border-error-300 focus:ring-error-500/20': error,
      'border-gray-300 dark:border-gray-700 focus:border-brand-300 focus:ring-brand-500/10': !error
    }"
    class="h-11 flex-1 border-y bg-transparent px-4 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:outline-hidden focus:ring-3 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 disabled:cursor-not-allowed disabled:opacity-50" 
  />

  <!-- Dropdown position: End -->
  @if (selectPosition === 'end') {
    <div class="relative z-10 flex-shrink-0">
      <!-- Country Selector Button -->
      <button
        type="button"
        (click)="toggleDropdown()"
        [disabled]="disabled"
        class="h-11 rounded-r-lg border-l-0 border-y border-r bg-white dark:bg-gray-900 px-3.5 pr-7 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 focus:outline-hidden focus:ring-2 focus:ring-brand-500/20 disabled:cursor-not-allowed disabled:opacity-50 transition-colors flex items-center justify-center gap-1.5 shadow-theme-xs"
        [ngClass]="{
          'border-error-500': error,
          'border-gray-300 dark:border-gray-700': !error
        }"
      >
        <span class="font-medium whitespace-nowrap">{{ getSelectedCountryLabel() }}</span>
        <svg
          class="stroke-current transition-transform flex-shrink-0"
          [ngClass]="{'rotate-180': isDropdownOpen}"
          width="16"
          height="16"
          viewBox="0 0 16 16"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M3.8335 5.9165L8.00016 10.0832L12.1668 5.9165" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </button>

      <!-- Custom Dropdown Menu -->
      @if (isDropdownOpen) {
        <div class="absolute right-0 top-full mt-1 z-50 w-48 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg shadow-lg max-h-80 overflow-y-auto">
          @for (country of availableCountries; track country.code) {
            <button
              type="button"
              (click)="selectCountry(country)"
              class="w-full px-4 py-2.5 text-left text-sm hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex items-center justify-between"
              [ngClass]="{
                'bg-brand-50 dark:bg-brand-500/10 text-brand-600 dark:text-brand-400': selectedCountry === country.code,
                'text-gray-700 dark:text-gray-300': selectedCountry !== country.code
              }"
            >
              <span class="font-medium">{{ country.label }}</span>
              @if (selectedCountry === country.code) {
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
              }
            </button>
          }
        </div>
      }
    </div>
  }
</div>