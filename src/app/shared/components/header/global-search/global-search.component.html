<div class="relative">
  <!-- Search Input -->
  <div class="relative">
    <span class="absolute -translate-y-1/2 pointer-events-none left-4 top-1/2">
      <svg class="fill-gray-500 dark:fill-gray-400" width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path fill-rule="evenodd" clip-rule="evenodd"
          d="M3.04175 9.37363C3.04175 5.87693 5.87711 3.04199 9.37508 3.04199C12.8731 3.04199 15.7084 5.87693 15.7084 9.37363C15.7084 12.8703 12.8731 15.7053 9.37508 15.7053C5.87711 15.7053 3.04175 12.8703 3.04175 9.37363ZM9.37508 1.54199C5.04902 1.54199 1.54175 5.04817 1.54175 9.37363C1.54175 13.6991 5.04902 17.2053 9.37508 17.2053C11.2674 17.2053 13.003 16.5344 14.357 15.4176L17.177 18.238C17.4699 18.5309 17.9448 18.5309 18.2377 18.238C18.5306 17.9451 18.5306 17.4703 18.2377 17.1774L15.418 14.3573C16.5365 13.0033 17.2084 11.2669 17.2084 9.37363C17.2084 5.04817 13.7011 1.54199 9.37508 1.54199Z"
          fill="currentColor" />
      </svg>
    </span>
    <input 
      #searchInput
      type="text" 
      [(ngModel)]="searchQuery"
      (input)="onSearchChange()"
      (focus)="onInputFocus()"
      placeholder="Search entities, users, profiles, roles..."
      class="dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-200 bg-transparent py-2.5 pl-12 pr-14 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-800 dark:bg-gray-900 dark:bg-white/[0.03] dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800 xl:w-[430px]" />
    @if (searchQuery) {
      <button 
        (click)="clearSearch()"
        class="absolute right-12 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    }
    <button
      class="absolute right-2.5 top-1/2 inline-flex -translate-y-1/2 items-center gap-0.5 rounded-lg border border-gray-200 bg-gray-50 px-[7px] py-[4.5px] text-xs -tracking-[0.2px] text-gray-500 dark:border-gray-800 dark:bg-white/[0.03] dark:text-gray-400">
      <span> âŒ˜ </span>
      <span> K </span>
    </button>
  </div>

  <!-- Search Results Dropdown -->
  @if (isOpen && (searchQuery || results || loading || error)) {
    <div 
      #searchResults
      class="absolute top-full left-0 right-0 xl:left-auto xl:right-0 mt-2 w-full xl:w-[600px] max-h-[600px] overflow-y-auto bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg shadow-xl z-50">
      
      <!-- Loading State -->
      @if (loading) {
        <div class="flex items-center justify-center p-8">
          <div class="flex flex-col items-center gap-3">
            <svg class="animate-spin h-8 w-8 text-brand-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm text-gray-500 dark:text-gray-400">Searching...</p>
          </div>
        </div>
      }

      <!-- Error State -->
      @if (error && !loading) {
        <div class="p-4 text-sm text-red-600 dark:text-red-400">
          {{ error }}
        </div>
      }

      <!-- Hierarchy View -->
      @if (selectedResult && !loadingHierarchy && selectedResult.hierarchyResponse) {
        <div class="p-4">
          <button 
            (click)="backToResults()"
            class="flex items-center gap-2 mb-4 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back to results
          </button>
          <app-hierarchy-tree 
            [hierarchyResponse]="selectedResult.hierarchyResponse" 
            [type]="selectedResult.type">
          </app-hierarchy-tree>
        </div>
      }

      <!-- Loading Hierarchy -->
      @if (loadingHierarchy) {
        <div class="flex items-center justify-center p-8">
          <div class="flex flex-col items-center gap-3">
            <svg class="animate-spin h-6 w-6 text-brand-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm text-gray-500 dark:text-gray-400">Loading hierarchy...</p>
          </div>
        </div>
      }

      <!-- Search Results -->
      @if (!selectedResult && !loading && !loadingHierarchy && results) {
        @if (hasResults()) {
          <div class="p-2">
            <!-- Entities Section -->
            @if (results.entities.total > 0) {
              <div class="mb-4">
                <div class="flex items-center gap-2 px-3 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-blue-500">
                    <path d="M3 7V5C3 3.89543 3.89543 3 5 3H9C10.1046 3 11 3.89543 11 5V7M3 7H21M3 7V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V7M21 7V5C21 3.89543 20.1046 3 19 3H15C13.8954 3 13 3.89543 13 5V7M7 3V7M17 3V7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  Entities ({{ results.entities.total }})
                </div>
                <div class="space-y-1">
                  @for (entity of results.entities.data; track entity.id) {
                    <button 
                      (click)="onResultClick('entity', entity.id)"
                      class="w-full flex items-start gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors text-left group">
                      <div class="flex-shrink-0 mt-0.5">
                        <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="text-blue-600 dark:text-blue-400">
                            <path d="M3 7V5C3 3.89543 3.89543 3 5 3H9C10.1046 3 11 3.89543 11 5V7M3 7H21M3 7V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V7M21 7V5C21 3.89543 20.1046 3 19 3H15C13.8954 3 13 3.89543 13 5V7M7 3V7M17 3V7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          </svg>
                        </div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="font-medium text-gray-900 dark:text-white group-hover:text-brand-600 dark:group-hover:text-brand-400">
                          {{ entity.name }}
                        </div>
                        @if (entity.email_id) {
                          <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 truncate">
                            {{ entity.email_id }}
                          </div>
                        }
                      </div>
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="flex-shrink-0 mt-1.5 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  }
                </div>
              </div>
            }

            <!-- Users Section -->
            @if (results.users.total > 0) {
              <div class="mb-4">
                <div class="flex items-center gap-2 px-3 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-green-500">
                    <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Users ({{ results.users.total }})
                </div>
                <div class="space-y-1">
                  @for (user of results.users.data; track user.id) {
                    <button 
                      (click)="onResultClick('user', user.id)"
                      class="w-full flex items-start gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors text-left group">
                      <div class="flex-shrink-0 mt-0.5">
                        <div class="w-8 h-8 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="text-green-600 dark:text-green-400">
                            <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="font-medium text-gray-900 dark:text-white group-hover:text-brand-600 dark:group-hover:text-brand-400">
                          {{ user.name }}
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 truncate">
                          {{ user.email }}
                        </div>
                      </div>
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="flex-shrink-0 mt-1.5 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  }
                </div>
              </div>
            }

            <!-- Profiles Section -->
            @if (results.profiles.total > 0) {
              <div class="mb-4">
                <div class="flex items-center gap-2 px-3 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-purple-500">
                    <path d="M9 12H15M9 16H15M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H12.5858C12.851 3 13.1054 3.10536 13.2929 3.29289L18.7071 8.70711C18.8946 8.89464 19 9.149 19 9.41421V19C19 20.1046 18.1046 21 17 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Profiles ({{ results.profiles.total }})
                </div>
                <div class="space-y-1">
                  @for (profile of results.profiles.data; track profile.id) {
                    <button 
                      (click)="onResultClick('profile', profile.id)"
                      class="w-full flex items-start gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors text-left group">
                      <div class="flex-shrink-0 mt-0.5">
                        <div class="w-8 h-8 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="text-purple-600 dark:text-purple-400">
                            <path d="M9 12H15M9 16H15M17 21H7C5.89543 21 5 20.1046 5 19V5C5 3.89543 5.89543 3 7 3H12.5858C12.851 3 13.1054 3.10536 13.2929 3.29289L18.7071 8.70711C18.8946 8.89464 19 9.149 19 9.41421V19C19 20.1046 18.1046 21 17 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="font-medium text-gray-900 dark:text-white group-hover:text-brand-600 dark:group-hover:text-brand-400">
                          {{ profile.name }}
                        </div>
                      </div>
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="flex-shrink-0 mt-1.5 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  }
                </div>
              </div>
            }

            <!-- Roles Section -->
            @if (results.roles.total > 0) {
              <div class="mb-4">
                <div class="flex items-center gap-2 px-3 py-2 text-sm font-semibold text-gray-700 dark:text-gray-300">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-orange-500">
                    <path d="M12 15C15.866 15 19 11.866 19 8C19 4.13401 15.866 1 12 1C8.13401 1 5 4.13401 5 8C5 11.866 8.13401 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8.21 13.89L7 23L12 20L17 23L15.79 13.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Roles ({{ results.roles.total }})
                </div>
                <div class="space-y-1">
                  @for (role of results.roles.data; track role.id) {
                    <button 
                      (click)="onResultClick('role', role.id)"
                      class="w-full flex items-start gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors text-left group">
                      <div class="flex-shrink-0 mt-0.5">
                        <div class="w-8 h-8 rounded-lg bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="text-orange-600 dark:text-orange-400">
                            <path d="M12 15C15.866 15 19 11.866 19 8C19 4.13401 15.866 1 12 1C8.13401 1 5 4.13401 5 8C5 11.866 8.13401 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8.21 13.89L7 23L12 20L17 23L15.79 13.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="font-medium text-gray-900 dark:text-white group-hover:text-brand-600 dark:group-hover:text-brand-400">
                          {{ role.name }}
                        </div>
                      </div>
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="flex-shrink-0 mt-1.5 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  }
                </div>
              </div>
            }
          </div>
        } @else {
          <!-- Empty State -->
          <div class="flex flex-col items-center justify-center p-12 text-center">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" class="text-gray-400 mb-4">
              <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">No results found</p>
            <p class="text-xs text-gray-500 dark:text-gray-400">Try a different search term</p>
          </div>
        }
      }
    </div>
  }
</div>

